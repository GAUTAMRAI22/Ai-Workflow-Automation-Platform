backend/app/api/v1/workflows.py
"""
Workflow API endpoints
"""
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.orm import Session
from typing import List
from uuid import UUID

from app.database import get_db
from app.models.workflow import Workflow, WorkflowStatus
from app.schemas.workflow import WorkflowCreate, WorkflowUpdate, WorkflowResponse
from app.services.workflow_service import workflow_service
from app.ai.parser import workflow_parser
from app.ai.validator import workflow_validator
from app.dependencies import get_current_user
from app.models.user import User

router = APIRouter()


@router.post("/from-text", response_model=WorkflowResponse)
async def create_workflow_from_text(
    description: str,
    name: str = None,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """Create workflow from natural language description"""
    try:
        # Parse natural language to workflow definition
        workflow_def = workflow_parser.parse(description)
        
        # Validate workflow
        is_valid, errors = workflow_validator.validate(workflow_def)
        if not is_valid:
            error_messages = [e.message for e in errors if e.severity == "error"]
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail={"message": "Workflow validation failed", "errors": error_messages}
            )
        
        # Create workflow
        workflow_data = WorkflowCreate(
            name=name or "AI Generated Workflow",
            description=description,
            definition=workflow_def,
            trigger_type=workflow_def["trigger"]["type"],
            trigger_config=workflow_def["trigger"].get("config", {}),
            ai_generated=True,
            natural_language_prompt=description
        )
        
        workflow = workflow_service.create_workflow(db, workflow_data, current_user.id)
        return workflow
        
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=str(e)
        )


@router.post("/", response_model=WorkflowResponse)
async def create_workflow(
    workflow: WorkflowCreate,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """Create workflow manually"""
    # Validate workflow
    is_valid, errors = workflow_validator.validate(workflow.definition)
    if not is_valid:
        error_messages = [e.message for e in errors if e.severity == "error"]
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail={"message": "Workflow validation failed", "errors": error_messages}
        )
    
    return workflow_service.create_workflow(db, workflow, current_user.id)


@router.get("/", response_model=List[WorkflowResponse])
async def list_workflows(
    skip: int = 0,
    limit: int = 100,
    status: WorkflowStatus = None,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """List all workflows"""
    return workflow_service.get_workflows(db, current_user.id, skip, limit, status)


@router.get("/{workflow_id}", response_model=WorkflowResponse)
async def get_workflow(
    workflow_id: UUID,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """Get workflow by ID"""
    workflow = workflow_service.get_workflow(db, workflow_id)
    if not workflow:
        raise HTTPException(status_code=404, detail="Workflow not found")
    return workflow


@router.put("/{workflow_id}", response_model=WorkflowResponse)
async def update_workflow(
    workflow_id: UUID,
    workflow_update: WorkflowUpdate,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """Update workflow"""
    workflow = workflow_service.update_workflow(db, workflow_id, workflow_update)
    if not workflow:
        raise HTTPException(status_code=404, detail="Workflow not found")
    return workflow


@router.delete("/{workflow_id}")
async def delete_workflow(
    workflow_id: UUID,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """Delete workflow"""
    success = workflow_service.delete_workflow(db, workflow_id)
    if not success:
        raise HTTPException(status_code=404, detail="Workflow not found")
    return {"message": "Workflow deleted successfully"}


@router.post("/{workflow_id}/execute")
async def execute_workflow(
    workflow_id: UUID,
    input_data: dict = None,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """Execute workflow"""
    execution = workflow_service.execute_workflow(db, workflow_id, input_data)
    return {"execution_id": execution.id, "status": execution.status}


backend/app/api/v1/executions.py
"""
Execution API endpoints
"""
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
from uuid import UUID

from app.database import get_db
from app.schemas.execution import ExecutionResponse
from app.services.execution_service import execution_service
from app.dependencies import get_current_user
from app.models.user import User

router = APIRouter()


@router.get("/", response_model=List[ExecutionResponse])
async def list_executions(
    workflow_id: UUID = None,
    status: str = None,
    skip: int = 0,
    limit: int = 100,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """List executions"""
    return execution_service.get_executions(db, workflow_id, status, skip, limit)


@router.get("/{execution_id}", response_model=ExecutionResponse)
async def get_execution(
    execution_id: UUID,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """Get execution details"""
    execution = execution_service.get_execution(db, execution_id)
    if not execution:
        raise HTTPException(status_code=404, detail="Execution not found")
    return execution


@router.get("/{execution_id}/summary")
async def get_execution_summary(
    execution_id: UUID,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """Get AI-generated execution summary"""
    summary = execution_service.generate_execution_summary(db, execution_id)
    if not summary:
        raise HTTPException(status_code=404, detail="Execution not found")
    return {"summary": summary}


@router.post("/{execution_id}/retry")
async def retry_execution(
    execution_id: UUID,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """Retry failed execution"""
    new_execution = execution_service.retry_execution(db, execution_id)
    return {"execution_id": new_execution.id, "status": new_execution.status}


backend/app/api/v1/ai.py
"""
AI API endpoints
"""
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session

from app.database import get_db
from app.ai.parser import workflow_parser
from app.ai.validator import workflow_validator
from app.ai.optimizer import workflow_optimizer
from app.dependencies import get_current_user
from app.models.user import User

router = APIRouter()


@router.post("/parse")
async def parse_natural_language(
    text: str,
    current_user: User = Depends(get_current_user)
):
    """Parse natural language to workflow definition"""
    try:
        workflow_def = workflow_parser.parse(text)
        return {"workflow": workflow_def}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/validate")
async def validate_workflow(
    workflow: dict,
    current_user: User = Depends(get_current_user)
):
    """Validate workflow definition"""
    is_valid, errors = workflow_validator.validate(workflow)
    return {
        "valid": is_valid,
        "errors": [{"severity": e.severity, "message": e.message, "location": e.location} 
                   for e in errors]
    }


@router.post("/optimize")
async def optimize_workflow(
    workflow_id: str,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """Get optimization suggestions for workflow"""
    suggestions = workflow_optimizer.analyze(workflow_id, db)
    return {"suggestions": suggestions}

